sap.ui.define(["./BaseController","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/IconTabBar","sap/m/IconTabFilter","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/model/odata/v2/ODataModel","sap/m/MessageBox","sap/ui/core/UIComponent","sap/m/GenericTile","sap/m/TileContent","sap/m/ImageContent","sap/m/Text","sap/ui/comp/library","sap/ui/model/type/String","sap/m/ColumnListItem","sap/m/Label","sap/m/SearchField","sap/m/Token","sap/ui/table/Column","sap/m/Column"],function(e,t,o,s,i,a,r,n,l,c,d,u,g,h,p,m,f,w,y,P,I,v,b){"use strict";return e.extend("com.app.artihcus.controller.MainPage",{onInit:function(){this.MaterialModel=new r;this.getView().setModel(this.MaterialModel,"MaterialModel");this.ogenerictitesIdarray=[];this.oObject={"14FT":"https://www.searates.com/design/images/apps/load-calculator/20st.svg","14FTF":"https://www.searates.com/design/images/apps/load-calculator/20ref.svg","17FT":"https://www.searates.com/design/images/apps/load-calculator/40st.svg","17FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg","22FT":"https://www.searates.com/design/images/apps/load-calculator/40hq.svg","22FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg","32FT":"https://www.searates.com/design/images/apps/load-calculator/40hq.svg","32FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg"};let e=this.oObject["14ft"];console.log(e);const t=new sap.ui.model.json.JSONModel({products:[]});this.getView().setModel(t,"oJsonModelProd");this.loadProductsFromLocalStorage();this.localModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.localModel,"localModel");const o=new r({Product:{sapProductno:"",length:"",width:"",height:"",volume:"",uom:"",vuom:"",wuom:"",muom:"",mCategory:"",description:"",EAN:"",netWeight:"",grossWeight:"",color:""},Vehicle:{truckType:"",length:"",width:"",height:"",uom:"",tvuom:"M続",tuom:"M",volume:"",truckWeight:"",capacity:"",freezed:""}});this.getView().setModel(o,"CombinedModel");const s=new r({TotalQuantity:"",TotalVolume:"",TotalWeight:"",RemainingCapacity:""});this.getView().setModel(s,"Calculation");const i=new sap.ui.model.json.JSONModel({chartData:[]});const a=new sap.ui.model.json.JSONModel;this.getView().setModel(i,"ChartData")},onbatchUpload:async function(e){if(!this.oFragment){this.oFragment=await this.loadFragment("MaterialXlData")}this.oFragment.open();await this._importData(e.getParameter("files")&&e.getParameter("files")[0])},_importData:function(e){var t=this;var o={};if(e&&window.FileReader){var s=new FileReader;s.onload=function(e){var s=new Uint8Array(e.target.result);var i=XLSX.read(s,{type:"array"});i.SheetNames.forEach(function(e){o=XLSX.utils.sheet_to_json(i.Sheets[e])});t.MaterialModel.setData({items:o});t.MaterialModel.refresh(true)};s.onerror=function(e){console.log(e)};s.readAsArrayBuffer(e)}},onBatchSave:async function(){var e=this;var t=e.getView().getModel("MaterialModel").getData();var o=[];var s=this.getView().getModel("ModelV2");var i="batchCreateGroup";let a=[];t.items.forEach((e,t)=>{e.length=String(e.length).trim();e.width=String(e.width).trim();e.height=String(e.height).trim();e.weight=String(e.weight).trim();e.quantity=String(e.quantity).trim();e.volume=String(e.volume).trim();o.push(s.create("/Materials",e,{method:"POST",groupId:i,success:function(e,t){},error:function(e){a.push(JSON.parse(e.responseText).error.message.value);console.error("Error creating material:",e)}}))});s.submitChanges({batchGroupId:i,success:function(e,t){c.success("Materials batch created successfully");console.log("Batch request submitted successfully",e)},error:function(e){c.success("Error creating material batch");console.error("Error in batch request:",e)}});if(this.oFragment){this.oFragment.close();this.byId("ProductsTable").getBinding("items").refresh()}},onClosePressXlData:function(){if(this.oFragment.isOpen()){this.oFragment.close()}},_createGenericTile:async function(){console.log("Called");var e=this.getView().byId("idVBoxInSelectVehicleType");var t=this;const o=this.getOwnerComponent().getModel("ModelV2"),s="/TruckTypes";var i={"14FT":"https://www.searates.com/design/images/apps/load-calculator/20st.svg","14FTF":"https://www.searates.com/design/images/apps/load-calculator/20ref.svg","17FT":"https://www.searates.com/design/images/apps/load-calculator/40st.svg","17FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg","22FT":"https://www.searates.com/design/images/apps/load-calculator/40hq.svg","22FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg","32FT":"https://www.searates.com/design/images/apps/load-calculator/40hq.svg","32FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg"};function a(e){if(e<14){return 14}else if(e>=14&&e<=16){return 14}else if(e>=17&&e<=21){return 17}else if(e>=22&&e<=31){return 22}else if(e>=32){return 32}return e}try{const r=await this.readData(o,s,[]);r.results.forEach(function(o){let s=o.truckType;let r=s.match(/\d+/g);let n=parseInt(r.join(""));let l=a(n);console.log(n);if(o.freezed){var c=o.truckType+"_f";var d=i[`${l}FTF`]}else{var c=o.truckType;var d=i[`${l}FT`]}if(!t.ogenerictitesIdarray.includes(c)){t.ogenerictitesIdarray.push(c);var p=new u({id:`id_generictile_${c}`,header:`${o.truckType}`,width:"150px",press:t.onPressGenericTilePress.bind(t)});p.addStyleClass("sapUiSmallMarginEnd sapUiTinyMarginTop");var m=new g({id:`id_idTileContent_${c}`});var f=new h({id:`id_idImageContentN_${c}`,src:`${d}`});m.setContent(f);p.addTileContent(m);e.addItem(p)}})}catch(e){console.log(e);n.show(e)}},onlivechangeValue_:function(e){var t=e.getSource();var o=t.getBindingContext();var s=parseFloat(t.getValue());var i=parseFloat(o.getProperty("quantity"));if(s>i){t.setValueState(sap.ui.core.ValueState.Error);t.setValueStateText("Picking Quantity cannot be greaterthan Actual Quantity.")}else if(s<=0){t.setValueState(sap.ui.core.ValueState.Error);t.setValueStateText("Picking Quantity cannot be lessthan or equal to zero.")}else{t.setValueState(sap.ui.core.ValueState.None);t.setValueStateText("")}},onDeletePressInSimulate:async function(){const e=this.getView().getModel("ModelV2");const t=this.byId("idAddProductsTableIn_simulate").getSelectedItems();if(!t){return c.error("Please select atleast one item for deletion")}t.forEach(t=>{let o=t.getBindingContext().getPath();e.remove(o,{success:function(){this.byId("idAddProductsTableIn_simulate").getBinding("items").refresh();n.show("Deleted successfully")}.bind(this),error:function(e){this.byId("idAddProductsTableIn_simulate").getBinding("items").refresh();c.error(e)}.bind(this)})})},onAddPress:function(){var e=this.byId("idTableAddProduct");var t=e.getSelectedItems();let o=0;var s=this.getOwnerComponent().getModel("ModelV2");if(t.length>0){var i=[];t.forEach(function(e){var t=e.getBindingContext();var s=t.getObject();var i=e.getCells()[4].mProperties;var a=i.value;var r=s.quantity;if(parseInt(a)>parseInt(r)||parseInt(a)<=0||!a){o=o+1}});if(o>0){n.show("Please Enter correct data");return}else{this.onAddPress1(t,s)}}else{n.show("Please select atleast one product")}},onAddPress1:function(e,t){debugger;var i=this;if(e.length>0){var a=[];e.forEach(async function(e){var r=e.getBindingContext();var l=r.getObject();var c=e.getCells()[4].mProperties;var d=c.value;var u={Productno_ID:l.ID,SelectedQuantity:d};a.push({product:l.sapProductno,description:l.description,actualQuantity:l.quantity,pickingQuantity:d});try{var g=await i.productExists(t,u.Productno_ID);if(!g){await i.createData(t,u,"/SelectedProduct");i.byId("idAddProductsTableIn_simulate")?.getBinding("items")?.refresh();return}await t.read("/SelectedProduct",{filters:[new o("Productno_ID",s.EQ,u.Productno_ID)],success:async function(e){console.log(e);var o=e.results[0].ID;await t.update("/SelectedProduct('"+o+"')",{SelectedQuantity:d},{success:function(){i.byId("idAddProductsTableIn_simulate")?.getBinding("items")?.refresh()}.bind(this),error:function(e){sap.m.MessageBox.error("Failed "+e.message)}.bind(this)})},error:function(e){console.log(e)}})}catch(e){console.log(e);n.show(e)}});this.oValueDialog.close()}else{n.show("No rows selected.")}},onCancelPress_valueHelp:function(){this.oValueDialog.close()},productExists:function(e,t){const i=this;return new Promise((i,a)=>{e.read("/SelectedProduct",{filters:[new o("Productno_ID",s.EQ,t)],success:function(e){i(e.results.length>0)},error:function(){a("An error occurred while checking username existence.")}})})},handleValueHelp:function(e){var o=e.getSource().getValue(),s=this.getView();if(!this._pValueHelpDialog){this._pValueHelpDialog=t.load({id:s.getId(),name:"com.app.artihcus.fragment.ProductsDialog",controller:this}).then(function(e){s.addDependent(e);return e})}this._pValueHelpDialog.then(function(e){e.open(o)})},handleValueHelpProductType:function(e){var o=e.getSource().getValue(),s=this.getView();if(!this._pProductsDialog){this._pProductsDialog=t.load({id:s.getId(),name:"com.app.artihcus.fragment.vehicleTypeDialog",controller:this}).then(function(e){s.addDependent(e);return e})}this._pProductsDialog.then(function(e){e.open(o)})},onPrintPressInProductsTable:function(){var e=this.byId("ProductsTable");var t=e.getItems();var o=[];var s=["SAP Productno","Description","EAN","Material Category","Length","Width","Height","Volume","UOM","Weight","Quantity","Layers","Mass","Layers_height"];o.push(s);t.forEach(function(e){var t=e.getCells();var s=[];t.forEach(function(e){s.push(e.getText())});o.push(s)});var i=XLSX.utils.aoa_to_sheet(o);var a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,i,"ProductsTable");XLSX.writeFile(a,"ProductsTable.xlsx")},onPressDownloadInAddContainerTable:function(){var e=this.byId("idContainerTypeTable");var t=e.getItems();var o=[];var s=["TruckType","Length(M)","Width(M)","Height(M)","Volume(M)","Capacity","TruckWeight"];o.push(s);t.forEach(function(e){var t=e.getCells();var s=[];t.forEach(function(e){s.push(e.getText())});o.push(s)});var i=XLSX.utils.aoa_to_sheet(o);var a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,i,"idProductsTableEdit");XLSX.writeFile(a,"ContainerTable.xlsx")},onPressPrintInListTable:function(){var e=this.byId("idListTable");var t=e.getItems();var o=[];var s=["S.No","Vehicle","Vehicle Type","Product","Product Type","Product Description","Dimensions","Volume","Weight","Capacity Used","Remaining Capacity"];o.push(s);t.forEach(function(e){var t=e.getCells();var s=[];t.forEach(function(e){s.push(e.getText())});o.push(s)});var i=XLSX.utils.aoa_to_sheet(o);var a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,i,"idListTable");XLSX.writeFile(a,"ListOfProductsInContainer.xlsx")},onPressInAddEquipment:async function(){if(!this.oCreateContainerDialog){this.oCreateContainerDialog=await this.loadFragment("CreateContainer")}this.oCreateContainerDialog.open();this.getView().getModel("CombinedModel").setProperty("/Vehicle",{})},onCancelInCreateVehicleDialog:function(){this.byId("idCreateInContainerDialog").close();this.ClearVeh()},oOpenProductEdit:async function(){if(!this.oEditDialog){this.oEditDialog=await this.loadFragment("EditProductDialog")}this.oEditDialog.open()},onCancelInEditProductDialog:function(){this.byId("idEditProductDssialog").close();this.getView().getModel("CombinedModel").setProperty("/Product",{})},onPressEditInAddEquipmentTable:async function(){if(!this.oEditInAddEquipment){this.oEditInAddEquipment=await this.loadFragment("EditContainer")}this.oEditInAddEquipment.open()},onCancelInEditVehicleDialog:function(){this.byId("idEditContainerDialog").close();this.getView().getModel("CombinedModel").setProperty("/Vehicle",{})},onPressAddInListTable:async function(){if(!this.oCreateInListDialog){this.oCreateInListDialog=await this.loadFragment("CreateInList")}this.oCreateInListDialog.open()},onCancelInListCreateDialog:function(){this.byId("idListssCreateDialog").close()},onPressEditInListTable:async function(){if(!this.oListEditDialog){this.oListEditDialog=await this.loadFragment("ListEditDialog")}this.oListEditDialog.open()},onCancelInListEditDialog:function(){this.byId("idListEdiwtDialog").close()},onCreateProduct:async function(){const e=function(){const e="0123456789ABCDEF";let t="#";for(let o=0;o<6;o++){t+=e[Math.floor(Math.random()*16)]}return t}();const t=this.getView().getModel("CombinedModel"),o=t.getProperty("/Product"),s=this.getView().getModel("ModelV2"),i=this.getView(),a="/Materials";const r=[];const l=(e,t,o,s)=>{const a=i.byId(e);if(!t||o&&!o.test(t)){a.setValueState("Error");a.setValueStateText(s);r.push(s)}else{a.setValueState("None")}};const d=[{Id:"idDescriptionInput_InitialView",value:o.sapProductno,regex:null,message:"Enter SAP product number"},{Id:"idInstanceNumberInput_InitialView",value:o.length,regex:/^\d+(\.\d+)?$/,message:"Length should be numeric"},{Id:"idClientInput_InitialView",value:o.width,regex:/^\d+(\.\d+)?$/,message:"Width should be numeric"},{Id:"idApplicationServerInput_InitialView",value:o.height,regex:/^\d+(\.\d+)?$/,message:"Height should be numeric"},{Id:"idSystemIdInput_InitialView",value:o.mCategory,regex:null,message:"Enter category"},{Id:"idInputDes_InitialView",value:o.description,regex:null,message:"Enter description"},{Id:"idWeightinput_InitialView",value:o.netWeight,regex:/^\d+(\.\d+)?$/,message:"Net Weight should be numeric"},{Id:"idGWeightinput_InitialView",value:o.grossWeight,regex:/^\d+(\.\d+)?$/,message:"Gross Weight should be numeric"},{Id:"idApplicationServerInput_MainPage",value:o.quantity,regex:/^\d+$/,message:"Quantity should be numeric"}];d.forEach(async e=>{l(e.Id,e.value,e.regex,e.message)});if(r.length>0){c.information("Please enter correct data");return}var u=this.byId("idselectuom").getSelectedKey();if(u==="Select"){c.error("Please Select UOM!!");return}o.uom=u;var g=this.byId("uomSelect").getSelectedKey();if(g==="Select"){c.error("Please Select UOM!!");return}o.muom="PC";o.vuom="M続";o.wuom=g;var h;o.color=e;if(o.uom==="CM"){h=o.length/100*(o.width/100)*(o.height/100);o.volume=String(h.toFixed(7))}else if(o.uom==="mm"){h=o.length/1e3*(o.width/1e3)*(o.height/1e3);o.volume=String(h.toFixed(7))}else{h=o.length*o.width*o.height;o.volume=String(h.toFixed(7))}try{await this.createData(s,o,a);this.getView().byId("ProductsTable").getBinding("items").refresh();this.byId("idselectuom").setSelectedKey("");this.byId("uomSelect").setSelectedKey("");n.show("Successfully Created!");this.getView().getModel("CombinedModel").setProperty("/Product",{});n.show("Successfully Created!")}catch(e){console.error(e);if(e.statusCode==="400"&&JSON.parse(e.responseText).error.message.value.toLowerCase()==="entity already exists"){c.information("Product Number Should be unique enter different value")}else{n.show("Facing technical issue")}}},ClearingModel:function(){const e=this.getView().getModel("CombinedModel");e.setProperty("/Product",{})},onProductDel:async function(){const e=this.byId("ProductsTable"),t=e.getSelectedItems(),o=this.getView().getModel("ModelV2");if(t.length===0){c.information("Please select at least one product to delete.");return}try{await Promise.all(t.map(async e=>{const t=e.getBindingContext().getPath();await this.deleteData(o,t)}));this.getView().byId("ProductsTable").getBinding("items").refresh();n.show("Successfully Deleted")}catch(e){n.show("Error Occurs")}},onliveContainerSearch:function(e){let t=e.getParameter("newValue");t=t.replace(/\s+/g,"");t=t.toUpperCase();if(t&&t.length>0){const e=new o("truckType",s.Contains,t),a=new o("capacity",s.Contains,t);var i=new o([e,a])}var a=this.byId("ProductsTable").getBinding("items");a.filter(i)},onCreateContainer:async function(){const e=this.getView().getModel("CombinedModel"),t=e.getProperty("/Vehicle"),o=this.getView().getModel("ModelV2"),s="/TruckTypes";if(!t.truckType||!t.length||!t.width||!t.height||!t.truckWeight||!t.capacity){c.warning("Please Enter all Values");return}const i=this.byId("idFreezedInput").getSelectedKey();if(!i){c.warning("Please Enter all Values");return}const a=i==="Yes"?true:false;t.freezed=a;t.truckType=`${t.truckType}FT`;var r=String(t.length)*String(t.width)*String(t.height);t.volume=parseFloat(r).toFixed(2);var l=this.byId("idContainerTypeUOM").getSelectedItem();t.uom=l?l.getKey():"";try{await this.createData(o,t,s);this.getView().getModel("CombinedModel").setProperty("/Vehicle",{}),this.byId("idContainerTypeTable").getBinding("items").refresh();this.onCancelInCreateVehicleDialog();this.byId("idFreezedInput").setSelectedKey("");this.byId("idContainerTypeUOM").setSelectedKey("");n.show("Successfully Created!")}catch(e){this.byId("idFreezedInput").setSelectedKey("");this.getView().getModel("CombinedModel").setProperty("/Vehicle",{}),this.onCancelInCreateVehicleDialog();n.show("Error at the time of creation")}},ClearVeh:function(){const e=this.getView().getModel("CombinedModel");e.setProperty("/Vehicle",{})},onContainerDel:async function(){const e=this.byId("idContainerTypeTable"),t=e.getSelectedItems(),o=this.getView().getModel("ModelV2");if(t.length===0){c.information("Please select at least one product to delete.");return}try{await Promise.all(t.map(async e=>{const t=e.getBindingContext().getPath();await this.deleteData(o,t)}));this.getView().byId("idContainerTypeTable").getBinding("items").refresh();n.show("Successfully Deleted")}catch(e){if(e){c.error("Error Occurs");return}}},onRow:function(e){var t=e.getSource()},onEditContainer:async function(){var e=this.byId("idContainerTypeTable").getSelectedItem();if(!e){c.information("Please select at least one Row for edit!");return}const t=e.getBindingContext().getObject();await this.onPressEditInAddEquipmentTable();this.getView().getModel("CombinedModel").setProperty("/Vehicle",t)},onSave:async function(){const e=this.getView().getModel("CombinedModel").getProperty("/Vehicle"),t=this.getView();const o=[{Id:"idVehInplength",value:e.length,regex:/^\d+(\.\d+)?$/,message:"Enter length as a numeric value"},{Id:"idVehInpWidth",value:e.width,regex:/^\d+(\.\d+)?$/,message:"Enter width as a numeric value"},{Id:"idVehInpheight",value:e.height,regex:/^\d+(\.\d+)?$/,message:"Enter height as a numeric value"},{Id:"idVehInptruckweight",value:e.truckWeight,regex:/^\d+(\.\d+)?$/,message:"Enter truck weight as numeric value"},{Id:"idVehInpcapacity",value:e.capacity,regex:/^\d+(\.\d+)?$/,message:"Enter capacity"}];let s=[];o.forEach(async e=>{let o=this.validateField(t,e.Id,e.value,e.regex,e.message);if(o.length>0){s.push(o[0])}});if(s.length>0){for(let e of s){c.information(e);return}}const i=e;const a=i;var r=String(a.length)*String(a.width)*String(a.height);a.volume=parseFloat(r).toFixed(2);const l=a.truckType,d=a.freezed;const u=this.getView().getModel("ModelV2");const g=`/TruckTypes(truckType='${l}',freezed='${d}')`;try{await this.updateData(u,a,g);this.byId("idContainerTypeTable").getBinding("items").refresh();this.onCancelInEditVehicleDialog();this.getView().getModel("ModelV2").setProperty("/Vehicle",{});n.show("Successfully Updated")}catch(e){n.show("Error")}finally{this.byId("idContainerTypeTable").getBinding("items").refresh();this.onCancelInEditVehicleDialog();this.getView().getModel("ModelV2").setProperty("/Vehicle",{})}},idTruckTypeTable:function(){this.getView().getModel("CombinedModel").setProperty("/Vehicle",{})},onPressEditInProductsTable:function(){debugger;var e=this.byId("ProductsTable");var t=e.getSelectedItems();if(t.length===0){sap.m.MessageToast.show("Please select atleast one row to edit.");return}if(t.length>1){sap.m.MessageToast.show("Please select only one row to edit.");return}this.byId("idEditBtnIcon4_ProductsTable").setVisible(false);this.byId("idSaveBtnIcon4_ProductsTable").setVisible(true);this.byId("idCancelBtnIcon4_ProductsTable").setVisible(true);var o=t[0];var s=o.getCells();this.pastDescription=s[1].getItems()[0].getText();this.pastMCategory=s[3].getItems()[0].getText();this.pastQuantity=s[4].getItems()[0].getText();this.pastLength=s[5].getItems()[0].getText();this.pastWidth=s[6].getItems()[0].getText();this.pastHeight=s[7].getItems()[0].getText();this.pastUOM=s[9].getItems()[0].getText();this.pastWeight=s[10].getItems()[0].getText();t.forEach(function(e){var t=e.getCells();t.forEach(function(e){if(e.isA("sap.m.HBox")){var t=e.getItems();if(t.length===2){t[0].setVisible(false);t[1].setVisible(true)}}})})},onSaveProduct:async function(){const e=this.getView().getModel("CombinedModel").getProperty("/Product");const t=e;var o=String(t.length)*String(t.width)*String(t.height);t.volume=parseFloat(o).toFixed(2);var s=e.ID;if(!s){sap.m.MessageBox.error("ID is not Found/Key Missing");return}const i=this.getView().getModel("ModelV2");const a=`/Materials('${s}')`;try{await this.updateData(i,t,a);this.getView().byId("ProductsTable").getBinding("items").refresh();this.onCancelInEditProductDialog();this.onClearEditProdDialog();n.show("Successfully Updated")}catch(e){this.onCancelInEditProductDialog();this.onClearEditProdDialog();n.show("Error")}},onClearEditProdDialog:function(){this.getView().getModel("CombinedModel").setProperty("/Product",{})},onTruckDetails:function(){const e=this.byId("idcdsse").getValue(),t=this.getView().getModel("ModelV2"),i="/TruckTypes";const a=new o("truckType",s.EQ,e);var r=this;t.read(i,{filters:[a],success:function(e){const t=e.results[0].volume,o=e.results[0].capacity},error:function(e){}})},onProdDetails:function(){const e=this.byId("idproducthelp").getValue(),t=this.getView().getModel("ModelV2"),i="/Materials";const a=new o("sapProductno",s.EQ,e);var r=this;t.read(i,{filters:[a],success:function(e){const t=e.results[0].volume;const o=r.byId("idSystemvgwddshjkIdInput_InitialView").getValue();const s=o/t;r.byId("idSystemvghjdfghkIdIhjnput_InitialView").setValue(s)},error:function(e){}})},onUpload:function(e){this._import(e.getParameter("files")&&e.getParameter("files")[0])},_import:function(e){var t=this;let o=t.getView().getModel("oJsonModelProd"),s=o.getData().products;var i={};if(e&&window.FileReader){var a=new FileReader;a.onload=function(e){var t=e.target.result;var a=XLSX.read(t,{type:"binary"});a.SheetNames.forEach(function(e){i=XLSX.utils.sheet_to_row_object_array(a.Sheets[e])});console.log(i);i.forEach(e=>{if(e.Weight){e.Weight+="KG"}});var r=[...new Set(i)];console.log(r);const n=[...s,...r];localStorage.setItem("productsData",JSON.stringify(n));o.setData({products:n});o.refresh(true)};a.onerror=function(e){console.log(e)};a.readAsBinaryString(e)}},onClickSimulate:async function(){var e=this.byId("idAddProductsTableIn_simulate");var t=e.getSelectedItems();var t=e.getSelectedItems();console.log("Selected Items Count:",t.length);console.log("Selected Items:",t);const o=this.byId("parkingLotSelect");const s=o.getSelectedKey();if(t.length>0){var i=[];t.forEach(function(t){var o=t.getBindingContext("oJsonModelProd");if(o){var s={Product:e.getModel("oJsonModelProd").getProperty("Product",o),MaterialDescription:e.getModel("oJsonModelProd").getProperty("MaterialDescription",o),Quantity:e.getModel("oJsonModelProd").getProperty("Quantity",o),Volume:e.getModel("oJsonModelProd").getProperty("Volume",o),Weight:e.getModel("oJsonModelProd").getProperty("Weight",o)};i.push(s)}else{console.error("Binding context is undefined for a selected item.")}});console.log("Selected Items Data:",i);const a=i.reduce((e,t)=>e+t.Volume,0);function r(e){let t=e.match(/(\d+\.?\d*)/);return t?parseFloat(t[0]):0}const n=i.reduce((e,t)=>e+r(t.Weight),0);console.log("Overall Total Weight:",n);console.log("Overall Total Volume:",a);console.log("Overall Total Volume:",n);await this.onContainerDetailsLoad().then(e=>{let t=[];e.forEach(e=>{if(!s||e.truckType===s){const o=Math.ceil(a/e.volume);const s=o>0?o:1;t.push({truckType:e.truckType,volume:e.volume,numberOfTrucksNeeded:s})}});console.log("Required Trucks for Loading:");t.forEach(e=>{console.log(`- ${e.truckType}: ${e.numberOfTrucksNeeded} truck(s) needed (Capacity: ${e.volume} Kgs)`)});const o={OverallTotalVolume:a,overallTotalWeight:n,Products:i,TProducts:i.length,RequiredTrucks:t};const r=new sap.ui.model.json.JSONModel(o);this.getView().setModel(r,"resultModel");this.getOwnerComponent().setModel(r,"resultModel");const l=this.getView().getModel("resultModel").getData();console.log(l);this.getView().byId("idAddProductsTableIn_simulate").getBinding("items").refresh();this.getView().getModel("resultModel").refresh();this.MoveToNextScreen();this.getView().byId("idAddProductsTableIn_simulate").getBinding("items").refresh();this.getView().getModel("resultModel").refresh()}).catch(e=>{console.error("Error loading truck details:",e)})}else{console.log("No items are selected.")}},onContainerDetailsLoad:function(){return new Promise((e,t)=>{const o="/TruckTypes";const s=this.getView().getModel("ModelV2");s.read(o,{success:function(t){e(t.results)},error:function(e){t(e)}})})},onLoadRequiredTrucks:async function(){if(!this.oReqContainerDialog){this.oReqContainerDialog=await this.loadFragment("RequiredContainer")}this.oReqContainerDialog.setModel(this.getView().getModel("resultModel"),"resultModel");const e=this.getView().getModel("resultModel").getProperty("/Products");const t=e?e.length:0;this.oReqContainerDialog.open()},onTruckDialogClose:function(){this.byId("truckLoadingDialog").close()},MoveToNextScreen:function(){const e=d.getRouterFor(this);e.navTo("ManuvalSimulation")},onLiveBinNumberTAble:function(e){let t=[];let i=e.getParameter("newValue");i=i.replace(/\s+/g,"");i=i.toUpperCase();if(i&&i.length>1){t.push(new o("sapProductno",s.EQ,i))}var a=this.byId("ProductsTable");var r=a.getBinding("items");r.filter(t)},onUploadMaterialCreation:function(e){this._import1(e.getParameter("files")&&e.getParameter("files")[0])},_import1:function(e){var t=this;if(e&&window.FileReader){var o=new FileReader;o.onload=function(e){var o=e.target.result;var s=XLSX.read(o,{type:"binary"});var i=[];s.SheetNames.forEach(function(e){const t=XLSX.utils.sheet_to_row_object_array(s.Sheets[e]);i=i.concat(t)});console.log(i);t.createProducts(i);t.localModel.refresh(true)};o.onerror=function(e){console.error("Error reading file:",e)};o.readAsBinaryString(e)}else{console.error("No file selected or FileReader not supported.")}},createProducts:async function(e){const t=this.getView().getModel("ModelV2");const o="/Materials";const s=[];for(const i of e){try{const e=this.checkProductExists(i["SAP Productno"]);if(e){console.warn(`Product with SAP Productno ${i["SAP Productno"]} already exists. Skipping creation.`);continue}const s={sapProductno:String(i["SAP Productno"]),length:String(i.Length),width:String(i.Width),height:String(i.Height),volume:String(i.Volume),uom:String(i.UOM),mCategory:String(i["Material Category"]),description:String(i.Description),EAN:String(i.EAN),weight:String(i.Weight),quantity:String(i.Quantity)};await this.createData(t,s,o);console.log(`Product created successfully: ${i.Description}`);this.byId("ProductsTable").getBinding("items").refresh()}catch(e){const t=`Error creating product ${i["SAP Productno"]}: ${e.message}`;console.error(t);s.push(t);c.error(t)}}},checkProductExists:function(e){if(!this.existingProducts||!Array.isArray(this.existingProducts)){console.error("existingProducts is not initialized or not an array.");return false}return this.existingProducts.some(t=>t.sapProductno===e)},loadExistingProducts:async function(){const e=this.getView().getModel("ModelV2");const t="/Materials";return new Promise((o,s)=>{e.read(t,{success:e=>{this.existingProducts=e.results;o()},error:e=>{console.error("Error loading existing products:",e);s(e)}})})},onClickSimulate11:function(){this.byId("Productarea").setVisible(false);this.byId("3dSimulator").setVisible(true)},onPressBacktomaterialupload:function(){this.byId("3dSimulator").setVisible(false);this.byId("Productarea").setVisible(true)},onSimulate:function(){var e=this.byId("parkingLotSelect").getSelectedKey();if(!e){c.warning("Please Select Truck Type");return}var t=this.byId("idproducthelp").getValue(),o=this.byId("idSystemvghjdfghkIdIhjnput_InitialView").getValue();if(!t){c.information("Please Enter Material!");return}if(!o){c.information("Please Enter  Quantity!");return}this.oProductRead(t,o)},oProductRead:async function(e,t){const i="/Materials",a=this.getView().getModel("ModelV2");const r=new o("sapProductno",s.EQ,e);try{const o=await this.readData(a,i,r);console.log("success");console.log(o);const s=o.results[0].volume;const l=o.results[0].weight;const c=parseFloat(l);const d=c*t+"KG";const u=s*t;const g=this.getView().getModel("oJsonModelProd");const h={Product:e,MaterialDescription:o.results[0].description,Quantity:t,Volume:u,Weight:d};let p=g.getProperty("/products")||[];p.push(h);g.setProperty("/products",p);this.byId("idproducthelp").setValue();this.byId("idSystemvghjdfghkIdIhjnput_InitialView").setValue();this.Blocking();localStorage.setItem("productsData",JSON.stringify(p));n.show("Materials read successfully!")}catch(e){c.warning("Please Enter Valid Material")}},Blocking:function(){var e=this.byId("idAddProductsTableIn_simulate").getItems().length;if(e>0){this.byId("parkingLotSelect").setEditable(false)}},loadProductsFromLocalStorage:function(){const e=this.getView().getModel("oJsonModelProd");if(!e){console.error("JSON Model 'oJsonModelProd' is not defined.");return}const t=localStorage.getItem("productsData");if(t){const o=JSON.parse(t);console.log("Loaded products from local storage:",o);if(Array.isArray(o)){e.setProperty("/products",o);console.log("Products set in model:",e.getProperty("/products"));this.getView().getModel("oJsonModelProd").refresh(true)}else{console.error("Loaded data is not an array:",o)}}else{console.log("No products found in local storage.")}},onRemoveSelectedProducts:function(){const e=this.getView().getModel("oJsonModelProd");const t=this.getView().byId("idAddProductsTableIn_simulate");const o=t.getSelectedItems();if(o.length>0){const s=e.getProperty("/products");const i=o.map(e=>e.getBindingContext("oJsonModelProd").getProperty("Product"));console.log("Selected Keys:",i);console.log("All Products:",s);const a=s.filter(e=>{const t=i.includes(e.Product);console.log(`Checking product: ${e.Product}, is selected: ${t}`);return!t});console.log("Filtered Products:",a);e.setProperty("/products",a);localStorage.setItem("productsData",JSON.stringify(a));t.getBinding("items").refresh();sap.m.MessageToast.show("Selected products have been removed.");this.Blocking()}else{e.setProperty("/products",[]);localStorage.removeItem("productsData");t.getBinding("items").refresh();sap.m.MessageToast.show("All products have been removed.")}},onNextInAddProduct:function(){var e=this.byId("idWizardIn_simulate");var t=e.getCurrentStep();e.nextStep();this._createGenericTile()},onPressStackBtn:async function(){if(!this.oStackDialog){this.oStackDialog=await this.loadFragment("Stack")}this.oStackDialog.open()},onCancelInStackDialog:function(){this.oStackDialog.close()},_createGenericStackTile:function(){var e=this.byId("VboxIdStacktiles")},onNextPressInSeconsSrInAddVehicleType:function(){debugger;this.getView().byId("idProcessQueueStep_changeQueue").setVisible(true)},onPressGenericTilePress:function(e){debugger;var t=this.byId("idWizardIn_simulate");var i=t.getCurrentStep();t.nextStep();const a=e.getSource();const r=a.getHeader();this._init3DScene();const n=this.getOwnerComponent().getModel("ModelV2");const l="/TruckTypes";const c=new o("truckType",s.EQ,r);n.read(l,{filters:[c],success:function(e){if(e.results.length>0){const t=parseFloat(e.results[0].height);const o=parseFloat(e.results[0].length);const s=parseFloat(e.results[0].width);this._createContainer(t,o,s)}else{console.error("No data found for the selected truck type.")}}.bind(this),error:function(e){console.error("Error fetching truck type data:",e)}})},onPressAddProductInSimulate:async function(){debugger;if(!this.oValueDialog){this.oValueDialog=await this.loadFragment("ValueHelp")}this.oValueDialog.open()},onValueHelpWithSuggestionsCancelPress:function(){this._oVHDWithSuggestions.close()},onPressTile:function(e){var t=e.getSource().getHeader();var o={Box:["https://www.searates.com/design/images/apps/load-calculator/boxes-layers.svg","https://www.searates.com/design/images/apps/load-calculator/boxes-height.svg","https://www.searates.com/design/images/apps/load-calculator/boxes-mass.svg"],Bigbags:["https://www.searates.com/design/images/apps/load-calculator/product-form/bigbags-layers.svg","https://www.searates.com/design/images/apps/load-calculator/product-form/bigbags-mass.svg","https://www.searates.com/design/images/apps/load-calculator/product-form/bigbags-height.svg"],Sacks:["https://www.searates.com/design/images/apps/load-calculator/product-form/sacks-layers.svg?3","https://www.searates.com/design/images/apps/load-calculator/product-form/sacks-height.svg?3","https://www.searates.com/design/images/apps/load-calculator/product-form/sacks-mass.svg?3"],Barrels:["https://www.searates.com/design/images/apps/load-calculator/barrels-layers.svg","https://www.searates.com/design/images/apps/load-calculator/barrels-height.svg","https://www.searates.com/design/images/apps/load-calculator/barrels-mass.svg"],Roll:["https://www.searates.com/design/images/apps/load-calculator/rolls-layers.svg","https://www.searates.com/design/images/apps/load-calculator/rolls-height.svg","https://www.searates.com/design/images/apps/load-calculator/rolls-mass.svg"],Pipes:["https://www.searates.com/design/images/apps/load-calculator/rolls-layers.svg","https://www.searates.com/design/images/apps/load-calculator/rolls-height.svg","https://www.searates.com/design/images/apps/load-calculator/rolls-mass.svg"],Bulk:[]};if(o[t]){var s=o[t];this.byId("idImageInStack").setSrc(s[0]);this.byId("idImage3InStack").setSrc(s[1]);this.byId("idImage43InStack").setSrc(s[2]);this.byId("imageDisplayHBox").setVisible(true)}},onPressAddButtonValueHelp:function(){var e=this.byId("idAssignedQueueTable_changeQueue");var t=e.getSelectedItems()},onPressBigBagsTile:function(){var e=new r({});this.getView().byId("idVbox4InStack").setModel(e,"oimage");var t=this.getView().byId("idVbox4InStack").getModel();const o=this.getView().byId("idVbox4InStack").getModel("oimage").getProperty("/");console.log(o)},_init3DScene:function(){if(this.scene){while(this.scene.children.length>0){this.scene.remove(this.scene.children[0])}}else{this.scene=new THREE.Scene;this.scene.background=new THREE.Color(16753920)}if(this.renderer){this.renderer.domElement.remove();this.renderer.dispose()}this.renderer=new THREE.WebGLRenderer({alpha:true});const e=document.getElementById("threejsCanvas");if(!e){console.error("Canvas container not found");return}this.renderer.setSize(800,600);this.renderer.outputEncoding=THREE.sRGBEncoding;this.renderer.shadowMap.enabled=true;e.appendChild(this.renderer.domElement);this.camera=new THREE.PerspectiveCamera(40,1e3/700,.1,1e3);this.camera.position.set(10,10,20);this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement);this.controls.enableDamping=true;this._addLighting();this._animate()},_createContainer:function(e,t,o){if(this.container){this.scene.remove(this.container);this.container.geometry.dispose();this.container.material.dispose()}const s=new THREE.BoxGeometry(t,e,o);const i=new THREE.MeshPhysicalMaterial({color:31743,metalness:.8,roughness:.4,opacity:.5,transparent:true,side:THREE.DoubleSide});this.container=new THREE.Mesh(s,i);this.container.castShadow=true;this.container.receiveShadow=true;this.container.position.set(0,e/2,0);this.scene.add(this.container);console.log("Container created with dimensions:",{height:e,length:t,width:o});const a=this.getView().byId("idAddProductsTableIn_simulate");const r=a.getSelectedItems();const n=r.map(e=>e.getBindingContext().getObject());console.log("Selected Items Data as Objects:",n);this._createProducts(n,e,t,o)},_createProducts:function(e,t,o,s){let i=-o/2;let a=-s/2;let r=0;const n=[];const l=[];let c=0;let d=0;let u=0;const g=t*o*s;const h=1e3;e.forEach(e=>{const t=parseInt(e.SelectedQuantity);const g=Math.max(parseFloat(e.Productno.length),.01);const h=Math.max(parseFloat(e.Productno.height),.01);const p=Math.max(parseFloat(e.Productno.width),.01);const m=e.Productno.color;const f=parseFloat(e.Productno.weight);const w=e.Productno.description;let y=0;let P=0;for(let e=0;e<t;e++){let e=true;while(e){if(i+g>o/2){i=-o/2;a+=p;if(a+p>s/2){a=-s/2;r+=h}}e=n.some(e=>i<e.xEnd&&i+g>e.xStart&&a<e.zEnd&&a+p>e.zStart&&r<e.yTop);if(e){i+=g}}if(!e){const e=new THREE.BoxGeometry(g,h,p);const t=new THREE.MeshStandardMaterial({color:new THREE.Color(m),metalness:.5,roughness:.5});const o=new THREE.Mesh(e,t);o.position.set(i+g/2,r+h/2,a+p/2);this.scene.add(o);const s=new THREE.EdgesGeometry(e);const l=new THREE.LineBasicMaterial({color:0});const w=new THREE.LineSegments(s,l);w.position.copy(o.position);this.scene.add(w);n.push({xStart:i,xEnd:i+g,zStart:a,zEnd:a+p,yTop:r+h});c++;const I=g*h*p;d+=I;u+=f;y+=I;P+=f;i+=g}}l.push({Name:w,Packages:t,Volume:y.toFixed(1),Weight:P.toFixed(1),Color:m})});const p=g-d;const m=h-u;l.push({Name:"Empty",Packages:0,Volume:p.toFixed(1),Weight:0,Color:"#cccccc"});this.getView().getModel("ChartData").setProperty("/chartData",l);this.getView().getModel("Calculation").setProperty("/",{TotalQuantity:c,TotalVolume:`${d.toFixed(1)} m続 (${(d/g*100).toFixed(1)}% filled)`,TotalWeight:`${u.toFixed(1)} kg`,RemainingCapacity:`${p.toFixed(1)} m続 (${(p/g*100).toFixed(1)}% empty)`});const f=this.getView().byId("idPieChart");f.setVizProperties({plotArea:{colorPalette:l.map(e=>e.Color),dataLabel:{visible:true}},title:{text:"Cargo Volume Breakdown"}})},_addLighting:function(){const e=new THREE.AmbientLight(16777215,.8);this.scene.add(e);const t=[{x:50,y:50,z:50},{x:-50,y:50,z:50},{x:50,y:50,z:-50},{x:-50,y:50,z:-50}];t.forEach(e=>{const t=new THREE.DirectionalLight(16777215,.5);t.position.set(e.x,e.y,e.z);this.scene.add(t)})},_animate:function(){const e=()=>{requestAnimationFrame(e);this.controls.update();this.renderer.render(this.scene,this.camera)};e()},onDownloadPressInSimulate:function(){var e=this.byId("idAddProductsTableIn_simulate");var t=e.getItems();var o=[];var s=["Product","Description","Quantity","Volume","Weight","Length","Width","Height","Color","Stack"];o.push(s);t.forEach(function(e){var t=e.getCells();var s=[];t.forEach(function(e){s.push(e.getText())});o.push(s)});var i=XLSX.utils.aoa_to_sheet(o);var a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,i,"ProductsListTable");XLSX.writeFile(a,"ProductsListTable.xlsx")}})});
//# sourceMappingURL=MainPage.controller.js.map