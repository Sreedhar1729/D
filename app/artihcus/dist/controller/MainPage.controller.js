sap.ui.define(["./BaseController","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/IconTabBar","sap/m/IconTabFilter","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/model/odata/v2/ODataModel","sap/m/MessageBox","sap/ui/core/UIComponent","sap/m/GenericTile","sap/m/TileContent","sap/m/ImageContent","sap/m/Text","sap/ui/comp/library","sap/ui/model/type/String","sap/m/ColumnListItem","sap/m/Label","sap/m/SearchField","sap/m/Token","sap/ui/table/Column","sap/m/Column"],function(e,t,s,i,o,a,n,r,l,d,c,u,g,h,p,m,y,I,w,f,b,P,v){"use strict";return e.extend("com.app.artihcus.controller.MainPage",{onInit:function(){this.ogenerictitesIdarray=[];this.oObject={"14FT":"https://www.searates.com/design/images/apps/load-calculator/20st.svg","14FTF":"https://www.searates.com/design/images/apps/load-calculator/20ref.svg","17FT":"https://www.searates.com/design/images/apps/load-calculator/40st.svg","17FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg","22FT":"https://www.searates.com/design/images/apps/load-calculator/40hq.svg","22FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg","32FT":"https://www.searates.com/design/images/apps/load-calculator/40hq.svg","32FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg"};let e=this.oObject["14ft"];console.log(e);const t=new sap.ui.model.json.JSONModel({products:[]});this.getView().setModel(t,"oJsonModelProd");this.loadProductsFromLocalStorage();this.localModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.localModel,"localModel");const s=new n({Product:{sapProductno:"",length:"",width:"",height:"",volume:"",uom:"",vuom:"",wuom:"",muom:"",mCategory:"",description:"",EAN:"",weight:"",color:""},Vehicle:{truckType:"",length:"",width:"",height:"",uom:"",tvuom:"M続",tuom:"M",volume:"",truckWeight:"",capacity:"",freezed:""}});this.getView().setModel(s,"CombinedModel")},_createGenericTile:async function(){console.log("Called");var e=this.getView().byId("idVBoxInSelectVehicleType");var t=this;const s=this.getOwnerComponent().getModel("ModelV2"),i="/TruckTypes";var o={"14FT":"https://www.searates.com/design/images/apps/load-calculator/20st.svg","14FTF":"https://www.searates.com/design/images/apps/load-calculator/20ref.svg","17FT":"https://www.searates.com/design/images/apps/load-calculator/40st.svg","17FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg","22FT":"https://www.searates.com/design/images/apps/load-calculator/40hq.svg","22FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg","32FT":"https://www.searates.com/design/images/apps/load-calculator/40hq.svg","32FTF":"https://www.searates.com/design/images/apps/load-calculator/40ref.svg"};function a(e){if(e<14){return 14}else if(e>=14&&e<=16){return 14}else if(e>=17&&e<=21){return 17}else if(e>=22&&e<=31){return 22}else if(e>=32){return 32}return e}try{const n=await this.readData(s,i,[]);n.results.forEach(function(s){let i=s.truckType;let n=i.match(/\d+/g);let r=parseInt(n.join(""));let l=a(r);console.log(r);if(s.freezed){var d=s.truckType+"_f";var c=o[`${l}FTF`]}else{var d=s.truckType;var c=o[`${l}FT`]}if(!t.ogenerictitesIdarray.includes(d)){t.ogenerictitesIdarray.push(d);var p=new u({id:`id_generictile_${d}`,header:`${s.truckType}`,width:"150px",press:t.onPressGenericTilePress.bind(t)});p.addStyleClass("sapUiSmallMarginEnd sapUiTinyMarginTop");var m=new g({id:`id_idTileContent_${d}`});var y=new h({id:`id_idImageContentN_${d}`,src:`${c}`});m.setContent(y);p.addTileContent(m);e.addItem(p)}})}catch(e){console.log(e);r.show(e)}},onlivechangeValue_:function(e){var t=e.getSource();var s=t.getBindingContext();var i=parseFloat(t.getValue());var o=parseFloat(s.getProperty("quantity"));if(i>o){t.setValueState(sap.ui.core.ValueState.Error);t.setValueStateText("Picking Quantity cannot be greaterthan Actual Quantity.")}else if(i<=0){t.setValueState(sap.ui.core.ValueState.Error);t.setValueStateText("Picking Quantity cannot be lessthan or equal to zero.")}else{t.setValueState(sap.ui.core.ValueState.None);t.setValueStateText("")}},onDeletePressInSimulate:async function(){var e=this.getOwnerComponent().getModel("ModelV2");await e.read("/SelectedProduct",{success:function(t){t.results.forEach(t=>{var s=t.ID;this.deleteData(e,`/SelectedProduct('${s}')`)})}.bind(this),error:function(){}});this.byId("idAddProductsTableIn_simulate")?.getBinding("items")?.refresh()},onAddPress:function(){var e=this.byId("idTableAddProduct");var t=e.getSelectedItems();let s=0;var i=this.getOwnerComponent().getModel("ModelV2");if(t.length>0){var o=[];t.forEach(function(e){var t=e.getBindingContext();var i=t.getObject();var o=e.getCells()[4].mProperties;var a=o.value;var n=i.quantity;if(parseInt(a)>parseInt(n)||parseInt(a)<=0||!a){s=s+1}});if(s>0){r.show("Please Enter correct data");return}else{this.onAddPress1(t,i)}}else{r.show("Please select atleast one product")}},onAddPress1:function(e,t){debugger;var o=this;if(e.length>0){var a=[];e.forEach(async function(e){var n=e.getBindingContext();var l=n.getObject();var d=e.getCells()[4].mProperties;var c=d.value;var u={Productno_ID:l.ID,SelectedQuantity:c};a.push({product:l.sapProductno,description:l.description,actualQuantity:l.quantity,pickingQuantity:c});try{var g=await o.productExists(t,u.Productno_ID);if(!g){await o.createData(t,u,"/SelectedProduct");o.byId("idAddProductsTableIn_simulate")?.getBinding("items")?.refresh();return}await t.read("/SelectedProduct",{filters:[new s("Productno_ID",i.EQ,u.Productno_ID)],success:async function(e){console.log(e);var s=e.results[0].ID;await t.update("/SelectedProduct('"+s+"')",{SelectedQuantity:c},{success:function(){o.byId("idAddProductsTableIn_simulate")?.getBinding("items")?.refresh()}.bind(this),error:function(e){sap.m.MessageBox.error("Failed "+e.message)}.bind(this)})},error:function(e){console.log(e)}})}catch(e){console.log(e);r.show(e)}});this.oValueDialog.close()}else{r.show("No rows selected.")}},onPressGenericTilePress:function(){var e=this.byId("idWizardIn_simulate");var t=e.getCurrentStep();e.nextStep()},onCancelPress_valueHelp:function(){this.oValueDialog.close()},productExists:function(e,t){const o=this;return new Promise((o,a)=>{e.read("/SelectedProduct",{filters:[new s("Productno_ID",i.EQ,t)],success:function(e){o(e.results.length>0)},error:function(){a("An error occurred while checking username existence.")}})})},handleValueHelp:function(e){var s=e.getSource().getValue(),i=this.getView();if(!this._pValueHelpDialog){this._pValueHelpDialog=t.load({id:i.getId(),name:"com.app.artihcus.fragment.ProductsDialog",controller:this}).then(function(e){i.addDependent(e);return e})}this._pValueHelpDialog.then(function(e){e.open(s)})},handleValueHelpProductType:function(e){var s=e.getSource().getValue(),i=this.getView();if(!this._pProductsDialog){this._pProductsDialog=t.load({id:i.getId(),name:"com.app.artihcus.fragment.vehicleTypeDialog",controller:this}).then(function(e){i.addDependent(e);return e})}this._pProductsDialog.then(function(e){e.open(s)})},onPrintPressInProductsTable:function(){var e=this.byId("ProductsTable");var t=e.getItems();var s=[];var i=["SAP Productno","Description","EAN","Material Category","Length","Width","Height","Volume","UOM","Weight","Quantity","Layers","Mass","Layers_height"];s.push(i);t.forEach(function(e){var t=e.getCells();var i=[];t.forEach(function(e){i.push(e.getText())});s.push(i)});var o=XLSX.utils.aoa_to_sheet(s);var a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,o,"ProductsTable");XLSX.writeFile(a,"ProductsTable.xlsx")},onPressDownloadInAddContainerTable:function(){var e=this.byId("idContainerTypeTable");var t=e.getItems();var s=[];var i=["TruckType","Length(M)","Width(M)","Height(M)","Volume(M)","Capacity","TruckWeight"];s.push(i);t.forEach(function(e){var t=e.getCells();var i=[];t.forEach(function(e){i.push(e.getText())});s.push(i)});var o=XLSX.utils.aoa_to_sheet(s);var a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,o,"idProductsTableEdit");XLSX.writeFile(a,"ContainerTable.xlsx")},onPressPrintInListTable:function(){var e=this.byId("idListTable");var t=e.getItems();var s=[];var i=["S.No","Vehicle","Vehicle Type","Product","Product Type","Product Description","Dimensions","Volume","Weight","Capacity Used","Remaining Capacity"];s.push(i);t.forEach(function(e){var t=e.getCells();var i=[];t.forEach(function(e){i.push(e.getText())});s.push(i)});var o=XLSX.utils.aoa_to_sheet(s);var a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,o,"idListTable");XLSX.writeFile(a,"ListOfProductsInContainer.xlsx")},onPressInAddEquipment:async function(){if(!this.oCreateContainerDialog){this.oCreateContainerDialog=await this.loadFragment("CreateContainer")}this.oCreateContainerDialog.open()},onCancelInCreateVehicleDialog:function(){this.byId("idCreateInContainerDialog").close();this.ClearVeh()},oOpenProductEdit:async function(){if(!this.oEditDialog){this.oEditDialog=await this.loadFragment("EditProductDialog")}this.oEditDialog.open()},onCancelInEditProductDialog:function(){this.byId("idEditProductDssialog").close()},onPressEditInAddEquipmentTable:async function(){if(!this.oEditInAddEquipment){this.oEditInAddEquipment=await this.loadFragment("EditContainer")}this.oEditInAddEquipment.open()},onCancelInEditVehicleDialog:function(){this.byId("idEditContainerDialog").close()},onPressAddInListTable:async function(){if(!this.oCreateInListDialog){this.oCreateInListDialog=await this.loadFragment("CreateInList")}this.oCreateInListDialog.open()},onCancelInListCreateDialog:function(){this.byId("idListssCreateDialog").close()},onPressEditInListTable:async function(){if(!this.oListEditDialog){this.oListEditDialog=await this.loadFragment("ListEditDialog")}this.oListEditDialog.open()},onCancelInListEditDialog:function(){this.byId("idListEdiwtDialog").close()},onCreateProduct:async function(){const e=function(){const e="0123456789ABCDEF";let t="#";for(let s=0;s<6;s++){t+=e[Math.floor(Math.random()*16)]}return t}();const t=this.getView().getModel("ProductModel"),s=t.getProperty("/"),i=this.getView().getModel("ModelV2"),o=this.getView(),a="/Materials";const n=[];const l=(e,t,s,i)=>{const a=o.byId(e);if(!t||s&&!s.test(t)){a.setValueState("Error");a.setValueStateText(i);n.push(i)}else{a.setValueState("None")}};const c=[{Id:"idDesvbncriptionInput_InitialView",value:s.EAN,regex:null,message:"Please enter EAN"},{Id:"idDescriptionInput_InitialView",value:s.sapProductno,regex:null,message:"Enter SAP product number"},{Id:"idInstanceNumberInput_InitialView",value:s.length,regex:/^\d+(\.\d+)?$/,message:"Length should be numeric"},{Id:"idClientInput_InitialView",value:s.width,regex:/^\d+(\.\d+)?$/,message:"Width should be numeric"},{Id:"idApplicationServerInput_InitialView",value:s.height,regex:/^\d+(\.\d+)?$/,message:"Height should be numeric"},{Id:"idSystemIdInput_InitialView",value:s.mCategory,regex:null,message:"Enter category"},{Id:"idInputDes_InitialView",value:s.description,regex:null,message:"Enter description"},{Id:"idWeightinput_InitialView",value:s.weight,regex:/^\d+$/,message:"Weight should be numeric"},{Id:"idApplicationServerInput_MainPage",value:s.quantity,regex:/^\d+$/,message:"Quantity should be numeric"}];c.forEach(async e=>{l(e.Id,e.value,e.regex,e.message)});if(n.length>0){d.information("Please enter correct data");return}var u=this.byId("idselectuom").getSelectedKey();if(u==="Select"){d.error("Please Select UOM!!");return}s.uom=u;var g=this.byId("uomSelect").getSelectedKey();if(g==="Select"){d.error("Please Select UOM!!");return}s.muom="PC";s.vuom="M続";s.wuom=g?g:"";var h;s.color=e;if(s.uom==="CM"){h=s.length/100*(s.width/100)*(s.height/100);s.volume=String(h.toFixed(7))}else{h=s.length*s.width*s.height;s.volume=String(h.toFixed(7))}try{await this.createData(i,s,a);this.getView().byId("ProductsTable").getBinding("items").refresh();this.byId("idselectuom").setSelectedKey("");this.byId("uomSelect").setSelectedKey("");r.show("Successfully Created!");this.getView().getModel("ProductModel").setProperty("/",{});r.show("Successfully Created!")}catch(e){console.error(e);if(e.statusCode==="400"&&JSON.parse(e.responseText).error.message.value.toLowerCase()==="entity already exists"){d.information("Product Number and EAN Should be unique enter different values")}else{r.show("Facing technical issue")}}},ClearingModel:function(){const e=this.getView().getModel("ProductModel");e.setProperty("/",{sapProductno:"",length:"",width:"",height:"",volume:"",uom:"",mCategory:"",description:"",EAN:"",weight:"",quantity:""})},onProductDel:async function(){const e=this.byId("ProductsTable"),t=e.getSelectedItems(),s=this.getView().getModel("ModelV2");if(t.length===0){d.information("Please select at least one product to delete.");return}try{await Promise.all(t.map(async e=>{const t=e.getBindingContext().getPath();await this.deleteData(s,t)}));this.getView().byId("ProductsTable").getBinding("items").refresh();r.show("Successfully Deleted")}catch(e){r.show("Error Occurs")}},onliveContainerSearch:function(e){let t=e.getParameter("newValue");t=t.replace(/\s+/g,"");t=t.toUpperCase();if(t&&t.length>0){const e=new s("truckType",i.Contains,t),a=new s("capacity",i.Contains,t);var o=new s([e,a])}var a=this.byId("ProductsTable").getBinding("items");a.filter(o)},onCreateContainer:async function(){const e=this.getView().getModel("CombinedModel"),t=e.getProperty("/Vehicle"),s=this.getView().getModel("ModelV2"),i="/TruckTypes";if(!t.truckType||!t.length||!t.width||!t.height||!t.truckWeight||!t.capacity){d.warning("Please Enter all Values");return}const o=this.byId("idFreezedInput").getSelectedKey();if(!o){d.warning("Please Enter all Values");return}const a=o==="Yes"?true:false;t.freezed=a;t.truckType=`${t.truckType}FT`;var n=String(t.length)*String(t.width)*String(t.height);t.volume=parseFloat(n).toFixed(2);var l=this.byId("idContainerTypeUOM").getSelectedItem();t.uom=l?l.getKey():"";try{await this.createData(s,t,i);this.getView().getModel("CombinedModel"),e.setProperty("/Vehicle",{}),this.byId("idContainerTypeTable").getBinding("items").refresh();this.onCancelInCreateVehicleDialog();this.byId("idFreezedInput").setSelectedKey("");this.byId("idContainerTypeUOM").setSelectedKey("");r.show("Successfully Created!")}catch(e){this.byId("idFreezedInput").setSelectedKey("");this.onCancelInCreateVehicleDialog();r.show("Error at the time of creation")}},ClearVeh:function(){const e=this.getView().getModel("CombinedModel");e.setProperty("/Vehicle",{truckType:"",length:"",width:"",height:"",uom:"",volume:"",truckWeight:"",capacity:""})},onContainerDel:async function(){const e=this.byId("idContainerTypeTable"),t=e.getSelectedItems(),s=this.getView().getModel("ModelV2");if(t.length===0){d.information("Please select at least one product to delete.");return}try{await Promise.all(t.map(async e=>{const t=e.getBindingContext().getPath();await this.deleteData(s,t)}));this.getView().byId("idContainerTypeTable").getBinding("items").refresh();r.show("Successfully Deleted")}catch(e){if(e){d.error("Error Occurs");return}}},onRow:function(e){var t=e.getSource()},onEditContainerContainer:async function(){var e=this.byId("idContainerTypeTable").getSelectedItem();if(!e){d.information("Please select at least one Row for edit!");return}const t=e.getBindingContext().getObject();await this.onPressEditInAddEquipmentTable();this.byId("editTruckTypeInput").setValue(t.truckType);this.byId("editLengthInput").setValue(t.length);this.byId("editWidthInput").setValue(t.width);this.byId("editHeightInput").setValue(t.height);this.byId("editTruckWeightInput").setValue(t.truckWeight);this.byId("editCapacityInput").setValue(t.capacity)},onSave:async function(){const e=this.byId("idContainerTypeTable").getSelectedItem().getBindingContext().getObject().freezed,t=this.byId("idSlectOPt").getSelectedKey()==="Yes"?true:false,s=this.getView().getModel("CombinedModel").getProperty("/Vehicle"),i=this.getView();const o=[{Id:"idVehInplength",value:s.length,regex:/^\d+(\.\d+)?$/,message:"Enter length as a numeric value"},{Id:"idVehInpWidth",value:s.width,regex:/^\d+(\.\d+)?$/,message:"Enter width as a numeric value"},{Id:"idVehInpheight",value:s.height,regex:/^\d+(\.\d+)?$/,message:"Enter height as a numeric value"},{Id:"idVehInptruckweight",value:s.truckWeight,regex:/^\d+(\.\d+)?$/,message:"Enter truck weight as numeric value"},{Id:"idVehInpcapacity",value:s.capacity,regex:/^\d+(\.\d+)?$/,message:"Enter capacity"}];let a=[];o.forEach(async e=>{let t=this.validateField(i,e.Id,e.value,e.regex,e.message);if(t.length>0){a.push(t[0])}});if(a.length>0){for(let e of a){d.information(e);return}}let n=this.byId("idSlectOPt").getSelectedKey();if(n==="Select"){d.information("Please select container type");return}const l={truckType:s.truckType,length:s.length,width:s.width,height:s.height,volume:"",truckWeight:this.byId("editTruckWeightInput").getValue(),capacity:this.byId("editCapacityInput").getValue()};var c=String(l.length)*String(l.width)*String(l.height);l.volume=parseFloat(c).toFixed(2);const u=this.byId("editTruckTypeInput").getValue();const g=this.getView().getModel("ModelV2");const h=`/TruckTypes('${u}')`;try{await this.updateData(g,l,h);this.byId("idTruckTypeTable").getBinding("items").refresh();this.onCancelInEditVehicleDialog();this.onClearEditDialog();r.show("Successfully Updated")}catch(e){r.show("Error")}finally{this.byId("idContainerTypeTable").getBinding("items").refresh();this.onCancelInEditVehicleDialog();this.onClearEditDialog();r.show("Error")}},idContainerTypeTable:function(){this.byId("editTruckTypeInput").setValue("");this.byId("editLengthInput").setValue("");this.byId("editWidthInput").setValue("");this.byId("editHeightInput").setValue("");this.byId("editTruckWeightInput").setValue("");this.byId("editCapacityInput").setValue("")},onPressEditInProductsTable:async function(){var e=this.byId("ProductsTable").getSelectedItem();if(!e){d.information("Please select at least one Row for edit!");return}const t=e.getBindingContext().getObject();await this.oOpenProductEdit();this.byId("editProductNoInput").setValue(t.sapProductno);this.byId("editDescriptionInput").setValue(t.description);this.byId("editEANInput").setValue(t.EAN);this.byId("editCategoryInput").setValue(t.mCategory);this.byId("editproLengthInput").setValue(t.length);this.byId("editprodWidthInput").setValue(t.width);this.byId("editprodHeightInput").setValue(t.height);this.byId("editUOMInput").setValue(t.uom);this.byId("editWeightInput").setValue(t.weight);this.byId("editQuantityInput").setValue(t.quantity)},onSaveProduct:async function(){const e={sapProductno:this.byId("editProductNoInput").getValue(),description:this.byId("editDescriptionInput").getValue(),EAN:this.byId("editEANInput").getValue(),mCategory:this.byId("editCategoryInput").getValue(),length:this.byId("editproLengthInput").getValue(),width:this.byId("editprodWidthInput").getValue(),height:this.byId("editprodHeightInput").getValue(),volume:"",uom:this.byId("editUOMInput").getValue(),weight:this.byId("editWeightInput").getValue(),quantity:this.byId("editQuantityInput").getValue()};const t=e;var s=String(t.length)*String(t.width)*String(t.height);t.volume=parseFloat(s).toFixed(2);const i=this.byId("editProductNoInput").getValue();const o=this.getView().getModel("ModelV2");const a=`/Materials('${i}')`;try{await this.updateData(o,t,a);this.getView().byId("ProductsTable").getBinding("items").refresh();this.onCancelInEditProductDialog();this.onClearEditProdDialog();r.show("Successfully Updated")}catch(e){this.onCancelInEditProductDialog();this.onClearEditProdDialog();r.show("Error")}},onClearEditProdDialog:function(){this.byId("editProductNoInput").setValue("");this.byId("editDescriptionInput").setValue("");this.byId("editEANInput").setValue("");this.byId("editCategoryInput").setValue("");this.byId("editproLengthInput").setValue("");this.byId("editprodWidthInput").setValue("");this.byId("editprodHeightInput").setValue("");this.byId("editUOMInput").setValue("");this.byId("editWeightInput").setValue("");this.byId("editQuantityInput").setValue("")},onTruckDetails:function(){const e=this.byId("idcdsse").getValue(),t=this.getView().getModel("ModelV2"),o="/TruckTypes";const a=new s("truckType",i.EQ,e);var n=this;t.read(o,{filters:[a],success:function(e){const t=e.results[0].volume,s=e.results[0].capacity},error:function(e){}})},onProdDetails:function(){const e=this.byId("idproducthelp").getValue(),t=this.getView().getModel("ModelV2"),o="/Materials";const a=new s("sapProductno",i.EQ,e);var n=this;t.read(o,{filters:[a],success:function(e){const t=e.results[0].volume;const s=n.byId("idSystemvgwddshjkIdInput_InitialView").getValue();const i=s/t;n.byId("idSystemvghjdfghkIdIhjnput_InitialView").setValue(i)},error:function(e){}})},onUpload:function(e){this._import(e.getParameter("files")&&e.getParameter("files")[0])},_import:function(e){var t=this;let s=t.getView().getModel("oJsonModelProd"),i=s.getData().products;var o={};if(e&&window.FileReader){var a=new FileReader;a.onload=function(e){var t=e.target.result;var a=XLSX.read(t,{type:"binary"});a.SheetNames.forEach(function(e){o=XLSX.utils.sheet_to_row_object_array(a.Sheets[e])});console.log(o);o.forEach(e=>{if(e.Weight){e.Weight+="KG"}});var n=[...new Set(o)];console.log(n);const r=[...i,...n];localStorage.setItem("productsData",JSON.stringify(r));s.setData({products:r});s.refresh(true)};a.onerror=function(e){console.log(e)};a.readAsBinaryString(e)}},onClickSimulate:async function(){var e=this.byId("idAddProductsTableIn_simulate");var t=e.getSelectedItems();var t=e.getSelectedItems();console.log("Selected Items Count:",t.length);console.log("Selected Items:",t);const s=this.byId("parkingLotSelect");const i=s.getSelectedKey();if(t.length>0){var o=[];t.forEach(function(t){var s=t.getBindingContext("oJsonModelProd");if(s){var i={Product:e.getModel("oJsonModelProd").getProperty("Product",s),MaterialDescription:e.getModel("oJsonModelProd").getProperty("MaterialDescription",s),Quantity:e.getModel("oJsonModelProd").getProperty("Quantity",s),Volume:e.getModel("oJsonModelProd").getProperty("Volume",s),Weight:e.getModel("oJsonModelProd").getProperty("Weight",s)};o.push(i)}else{console.error("Binding context is undefined for a selected item.")}});console.log("Selected Items Data:",o);const a=o.reduce((e,t)=>e+t.Volume,0);function n(e){let t=e.match(/(\d+\.?\d*)/);return t?parseFloat(t[0]):0}const r=o.reduce((e,t)=>e+n(t.Weight),0);console.log("Overall Total Weight:",r);console.log("Overall Total Volume:",a);console.log("Overall Total Volume:",r);await this.onContainerDetailsLoad().then(e=>{let t=[];e.forEach(e=>{if(!i||e.truckType===i){const s=Math.ceil(a/e.volume);const i=s>0?s:1;t.push({truckType:e.truckType,volume:e.volume,numberOfTrucksNeeded:i})}});console.log("Required Trucks for Loading:");t.forEach(e=>{console.log(`- ${e.truckType}: ${e.numberOfTrucksNeeded} truck(s) needed (Capacity: ${e.volume} Kgs)`)});const s={OverallTotalVolume:a,overallTotalWeight:r,Products:o,TProducts:o.length,RequiredTrucks:t};const n=new sap.ui.model.json.JSONModel(s);this.getView().setModel(n,"resultModel");this.getOwnerComponent().setModel(n,"resultModel");const l=this.getView().getModel("resultModel").getData();console.log(l);this.getView().byId("idAddProductsTableIn_simulate").getBinding("items").refresh();this.getView().getModel("resultModel").refresh();this.MoveToNextScreen();this.getView().byId("idAddProductsTableIn_simulate").getBinding("items").refresh();this.getView().getModel("resultModel").refresh()}).catch(e=>{console.error("Error loading truck details:",e)})}else{console.log("No items are selected.")}},onContainerDetailsLoad:function(){return new Promise((e,t)=>{const s="/TruckTypes";const i=this.getView().getModel("ModelV2");i.read(s,{success:function(t){e(t.results)},error:function(e){t(e)}})})},onLoadRequiredTrucks:async function(){if(!this.oReqContainerDialog){this.oReqContainerDialog=await this.loadFragment("RequiredContainer")}this.oReqContainerDialog.setModel(this.getView().getModel("resultModel"),"resultModel");const e=this.getView().getModel("resultModel").getProperty("/Products");const t=e?e.length:0;this.oReqContainerDialog.open()},onTruckDialogClose:function(){this.byId("truckLoadingDialog").close()},MoveToNextScreen:function(){const e=c.getRouterFor(this);e.navTo("ManuvalSimulation")},onLiveBinNumberTAble:function(e){let t=[];let o=e.getParameter("newValue");o=o.replace(/\s+/g,"");o=o.toUpperCase();if(o&&o.length>1){t.push(new s("sapProductno",i.EQ,o))}var a=this.byId("ProductsTable");var n=a.getBinding("items");n.filter(t)},onUploadMaterialCreation:function(e){this._import1(e.getParameter("files")&&e.getParameter("files")[0])},_import1:function(e){var t=this;if(e&&window.FileReader){var s=new FileReader;s.onload=function(e){var s=e.target.result;var i=XLSX.read(s,{type:"binary"});var o=[];i.SheetNames.forEach(function(e){const t=XLSX.utils.sheet_to_row_object_array(i.Sheets[e]);o=o.concat(t)});console.log(o);t.createProducts(o);t.localModel.refresh(true)};s.onerror=function(e){console.error("Error reading file:",e)};s.readAsBinaryString(e)}else{console.error("No file selected or FileReader not supported.")}},createProducts:async function(e){const t=this.getView().getModel("ModelV2");const s="/Materials";const i=[];for(const o of e){try{const e=this.checkProductExists(o["SAP Productno"]);if(e){console.warn(`Product with SAP Productno ${o["SAP Productno"]} already exists. Skipping creation.`);continue}const i={sapProductno:String(o["SAP Productno"]),length:String(o.Length),width:String(o.Width),height:String(o.Height),volume:String(o.Volume),uom:String(o.UOM),mCategory:String(o["Material Category"]),description:String(o.Description),EAN:String(o.EAN),weight:String(o.Weight),quantity:String(o.Quantity)};await this.createData(t,i,s);console.log(`Product created successfully: ${o.Description}`);this.byId("ProductsTable").getBinding("items").refresh()}catch(e){const t=`Error creating product ${o["SAP Productno"]}: ${e.message}`;console.error(t);i.push(t);d.error(t)}}},checkProductExists:function(e){if(!this.existingProducts||!Array.isArray(this.existingProducts)){console.error("existingProducts is not initialized or not an array.");return false}return this.existingProducts.some(t=>t.sapProductno===e)},loadExistingProducts:async function(){const e=this.getView().getModel("ModelV2");const t="/Materials";return new Promise((s,i)=>{e.read(t,{success:e=>{this.existingProducts=e.results;s()},error:e=>{console.error("Error loading existing products:",e);i(e)}})})},onClickSimulate11:function(){this.byId("Productarea").setVisible(false);this.byId("3dSimulator").setVisible(true)},onPressBacktomaterialupload:function(){this.byId("3dSimulator").setVisible(false);this.byId("Productarea").setVisible(true)},onSimulate:function(){var e=this.byId("parkingLotSelect").getSelectedKey();if(!e){d.warning("Please Select Truck Type");return}var t=this.byId("idproducthelp").getValue(),s=this.byId("idSystemvghjdfghkIdIhjnput_InitialView").getValue();if(!t){d.information("Please Enter Material!");return}if(!s){d.information("Please Enter  Quantity!");return}this.oProductRead(t,s)},oProductRead:async function(e,t){const o="/Materials",a=this.getView().getModel("ModelV2");const n=new s("sapProductno",i.EQ,e);try{const s=await this.readData(a,o,n);console.log("success");console.log(s);const i=s.results[0].volume;const l=s.results[0].weight;const d=parseFloat(l);const c=d*t+"KG";const u=i*t;const g=this.getView().getModel("oJsonModelProd");const h={Product:e,MaterialDescription:s.results[0].description,Quantity:t,Volume:u,Weight:c};let p=g.getProperty("/products")||[];p.push(h);g.setProperty("/products",p);this.byId("idproducthelp").setValue();this.byId("idSystemvghjdfghkIdIhjnput_InitialView").setValue();this.Blocking();localStorage.setItem("productsData",JSON.stringify(p));r.show("Materials read successfully!")}catch(e){d.warning("Please Enter Valid Material")}},Blocking:function(){var e=this.byId("idAddProductsTableIn_simulate").getItems().length;if(e>0){this.byId("parkingLotSelect").setEditable(false)}},loadProductsFromLocalStorage:function(){const e=this.getView().getModel("oJsonModelProd");if(!e){console.error("JSON Model 'oJsonModelProd' is not defined.");return}const t=localStorage.getItem("productsData");if(t){const s=JSON.parse(t);console.log("Loaded products from local storage:",s);if(Array.isArray(s)){e.setProperty("/products",s);console.log("Products set in model:",e.getProperty("/products"));this.getView().getModel("oJsonModelProd").refresh(true)}else{console.error("Loaded data is not an array:",s)}}else{console.log("No products found in local storage.")}},onRemoveSelectedProducts:function(){const e=this.getView().getModel("oJsonModelProd");const t=this.getView().byId("idAddProductsTableIn_simulate");const s=t.getSelectedItems();if(s.length>0){const i=e.getProperty("/products");const o=s.map(e=>e.getBindingContext("oJsonModelProd").getProperty("Product"));console.log("Selected Keys:",o);console.log("All Products:",i);const a=i.filter(e=>{const t=o.includes(e.Product);console.log(`Checking product: ${e.Product}, is selected: ${t}`);return!t});console.log("Filtered Products:",a);e.setProperty("/products",a);localStorage.setItem("productsData",JSON.stringify(a));t.getBinding("items").refresh();sap.m.MessageToast.show("Selected products have been removed.");this.Blocking()}else{e.setProperty("/products",[]);localStorage.removeItem("productsData");t.getBinding("items").refresh();sap.m.MessageToast.show("All products have been removed.")}},onNextInAddProduct:function(){var e=this.byId("idWizardIn_simulate");var t=e.getCurrentStep();e.nextStep();this._createGenericTile()},onPressStackBtn:async function(){if(!this.oStackDialog){this.oStackDialog=await this.loadFragment("Stack")}this.oStackDialog.open()},onCancelInStackDialog:function(){this.oStackDialog.close()},_createGenericStackTile:function(){var e=this.byId("VboxIdStacktiles")},onNextPressInSeconsSrInAddVehicleType:function(){debugger;this.getView().byId("idProcessQueueStep_changeQueue").setVisible(true)},onPressGenericTilePress:function(e){debugger;var t=this.byId("idWizardIn_simulate");var o=t.getCurrentStep();t.nextStep();const a=e.getSource();const n=a.getHeader();this._init3DScene();const r=this.getOwnerComponent().getModel("ModelV2");const l="/TruckTypes";const d=new s("truckType",i.EQ,n);r.read(l,{filters:[d],success:function(e){if(e.results.length>0){const t=parseFloat(e.results[0].height);const s=parseFloat(e.results[0].length);const i=parseFloat(e.results[0].width);this._createContainer(t,s,i)}else{console.error("No data found for the selected truck type.")}}.bind(this),error:function(e){console.error("Error fetching truck type data:",e)}})},onPressAddProductInSimulate:async function(){debugger;if(!this.oValueDialog){this.oValueDialog=await this.loadFragment("ValueHelp")}this.oValueDialog.open()},onValueHelpWithSuggestionsCancelPress:function(){this._oVHDWithSuggestions.close()},onPressTile:function(e){var t=e.getSource().getHeader();var s={Box:["https://www.searates.com/design/images/apps/load-calculator/boxes-layers.svg","https://www.searates.com/design/images/apps/load-calculator/boxes-height.svg","https://www.searates.com/design/images/apps/load-calculator/boxes-mass.svg"],Bigbags:["https://www.searates.com/design/images/apps/load-calculator/product-form/bigbags-layers.svg","https://www.searates.com/design/images/apps/load-calculator/product-form/bigbags-mass.svg","https://www.searates.com/design/images/apps/load-calculator/product-form/bigbags-height.svg"],Sacks:["https://www.searates.com/design/images/apps/load-calculator/product-form/sacks-layers.svg?3","https://www.searates.com/design/images/apps/load-calculator/product-form/sacks-height.svg?3","https://www.searates.com/design/images/apps/load-calculator/product-form/sacks-mass.svg?3"],Barrels:["https://www.searates.com/design/images/apps/load-calculator/barrels-layers.svg","https://www.searates.com/design/images/apps/load-calculator/barrels-height.svg","https://www.searates.com/design/images/apps/load-calculator/barrels-mass.svg"],Roll:["https://www.searates.com/design/images/apps/load-calculator/rolls-layers.svg","https://www.searates.com/design/images/apps/load-calculator/rolls-height.svg","https://www.searates.com/design/images/apps/load-calculator/rolls-mass.svg"],Pipes:["https://www.searates.com/design/images/apps/load-calculator/rolls-layers.svg","https://www.searates.com/design/images/apps/load-calculator/rolls-height.svg","https://www.searates.com/design/images/apps/load-calculator/rolls-mass.svg"],Bulk:[]};if(s[t]){var i=s[t];this.byId("idImageInStack").setSrc(i[0]);this.byId("idImage3InStack").setSrc(i[1]);this.byId("idImage43InStack").setSrc(i[2]);this.byId("imageDisplayHBox").setVisible(true)}},onPressAddButtonValueHelp:function(){var e=this.byId("idAssignedQueueTable_changeQueue");var t=e.getSelectedItems()},onPressBigBagsTile:function(){var e=new n({});this.getView().byId("idVbox4InStack").setModel(e,"oimage");var t=this.getView().byId("idVbox4InStack").getModel();const s=this.getView().byId("idVbox4InStack").getModel("oimage").getProperty("/");console.log(s)},_init3DScene:function(){if(this.scene){while(this.scene.children.length>0){this.scene.remove(this.scene.children[0])}}else{this.scene=new THREE.Scene;this.scene.background=new THREE.Color(16753920)}if(this.renderer){this.renderer.domElement.remove();this.renderer.dispose()}this.renderer=new THREE.WebGLRenderer({alpha:true});const e=document.getElementById("threejsCanvas");if(!e){console.error("Canvas container not found");return}this.renderer.setSize(800,600);this.renderer.outputEncoding=THREE.sRGBEncoding;this.renderer.shadowMap.enabled=true;e.appendChild(this.renderer.domElement);this.camera=new THREE.PerspectiveCamera(40,1e3/700,.1,1e3);this.camera.position.set(10,10,20);this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement);this.controls.enableDamping=true;this._addLighting();this._animate()},_createContainer:function(e,t,s){if(this.container){this.scene.remove(this.container);this.container.geometry.dispose();this.container.material.dispose()}const i=new THREE.BoxGeometry(t,e,s);const o=new THREE.MeshPhysicalMaterial({color:31743,metalness:.8,roughness:.4,opacity:.5,transparent:true,side:THREE.DoubleSide});this.container=new THREE.Mesh(i,o);this.container.castShadow=true;this.container.receiveShadow=true;this.container.position.set(0,e/2,0);this.scene.add(this.container);console.log("Container created with dimensions:",{height:e,length:t,width:s});const a=this.getView().byId("idAddProductsTableIn_simulate");const n=a.getSelectedItems();const r=n.map(e=>e.getBindingContext().getObject());console.log("Selected Items Data as Objects:",r);this._createProducts(r,e,t,s)},_createProducts:function(e,t,s,i){let o=-s/2;let a=-i/2;let n=0;const r=[];const l=[];let d=0;let c=0;let u=0;const g=t*s*i;const h=1e3;e.forEach(e=>{const t=parseInt(e.SelectedQuantity);const g=Math.max(parseFloat(e.Productno.length),.01);const h=Math.max(parseFloat(e.Productno.height),.01);const p=Math.max(parseFloat(e.Productno.width),.01);const m=e.Productno.color;const y=parseFloat(e.Productno.weight);const I=e.Productno.description;let w=0;let f=0;for(let e=0;e<t;e++){let e=true;while(e){if(o+g>s/2){o=-s/2;a+=p;if(a+p>i/2){a=-i/2;n+=h}}e=r.some(e=>o<e.xEnd&&o+g>e.xStart&&a<e.zEnd&&a+p>e.zStart&&n<e.yTop);if(e){o+=g}}if(!e){const e=new THREE.BoxGeometry(g,h,p);const t=new THREE.MeshStandardMaterial({color:new THREE.Color(m),metalness:.5,roughness:.5});const s=new THREE.Mesh(e,t);s.position.set(o+g/2,n+h/2,a+p/2);this.scene.add(s);const i=new THREE.EdgesGeometry(e);const l=new THREE.LineBasicMaterial({color:0});const I=new THREE.LineSegments(i,l);I.position.copy(s.position);this.scene.add(I);r.push({xStart:o,xEnd:o+g,zStart:a,zEnd:a+p,yTop:n+h});d++;const b=g*h*p;c+=b;u+=y;w+=b;f+=y;o+=g}}l.push({Name:I,Packages:t,Volume:w.toFixed(1),Weight:f.toFixed(1),Color:m})});const p=g-c;const m=h-u;l.push({Name:"Empty",Packages:0,Volume:p.toFixed(1),Weight:0,Color:"#cccccc"});this.getView().getModel("ChartData").setProperty("/chartData",l);this.getView().getModel("Calculation").setProperty("/",{TotalQuantity:d,TotalVolume:`${c.toFixed(1)} m続 (${(c/g*100).toFixed(1)}% filled)`,TotalWeight:`${u.toFixed(1)} kg`,RemainingCapacity:`${p.toFixed(1)} m続 (${(p/g*100).toFixed(1)}% empty)`});const y=this.getView().byId("idPieChart");y.setVizProperties({plotArea:{colorPalette:l.map(e=>e.Color),dataLabel:{visible:true}},title:{text:"Cargo Volume Breakdown"}})},_addLighting:function(){const e=new THREE.AmbientLight(16777215,.8);this.scene.add(e);const t=[{x:50,y:50,z:50},{x:-50,y:50,z:50},{x:50,y:50,z:-50},{x:-50,y:50,z:-50}];t.forEach(e=>{const t=new THREE.DirectionalLight(16777215,.5);t.position.set(e.x,e.y,e.z);this.scene.add(t)})},_animate:function(){const e=()=>{requestAnimationFrame(e);this.controls.update();this.renderer.render(this.scene,this.camera)};e()},onDownloadPressInSimulate:function(){var e=this.byId("idAddProductsTableIn_simulate");var t=e.getItems();var s=[];var i=["Product","Description","Quantity","Volume","Weight","Length","Width","Height","Color","Stack"];s.push(i);t.forEach(function(e){var t=e.getCells();var i=[];t.forEach(function(e){i.push(e.getText())});s.push(i)});var o=XLSX.utils.aoa_to_sheet(s);var a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,o,"ProductsListTable");XLSX.writeFile(a,"ProductsListTable.xlsx")}})});
//# sourceMappingURL=MainPage.controller.js.map